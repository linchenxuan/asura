# Asura 网络层设计文档

## 🏗️ 架构概览

Asura 网络模块采用 **四层分层架构**，专为分布式游戏服务器设计，提供高性能、可扩展的网络通信能力。

传输层(Transport) → 分发层(Dispatcher) → 消息层(MsgLayer) → 处理层(Handler)

二、传输层(Transport Layer)
核心设计特点：

插件化架构

支持多种传输协议：TCP、HTTP、Sidecar、LS
通过插件工厂模式动态加载
支持多传输协议并存
TCP传输实现 (/transport/tcp/tcp.go)

长连接模式：为每个UID维护持久连接
短连接模式：请求-响应后关闭
连接管理：使用uidToConn映射维护连接状态
安全通信：支持AES加密传输
消息格式

预头部(PreHead)：固定长度，包含消息元信息
消息头部(PkgHead)：包含路由、ID、Actor等信息
消息体(Body)：protobuf序列化的业务数据
三、分发层(Dispatcher Layer)
核心职责：

消息路由

根据消息类型分发到不同的MsgLayer
支持有状态(stateful)、无状态(stateless)、异步(async)三种模式
响应消息通过RPC ID路由回原始请求
流量控制

令牌桶算法：实现每秒接收消息数量限制
可热更新：支持运行时调整限流参数
消息过滤链：支持自定义过滤器
超时管理

RPC超时检查：基于消息头部的deadline
超时消息拒绝：避免处理过期请求
四、消息层(MsgLayer)
三种运行时模型：

无状态模型(Stateless)

并发模型：每个消息一个goroutine
协程熔断：通过GoroutineFuse限制最大并发数
消息过滤链：支持业务自定义过滤器
适用场景：API网关、计算密集型服务
有状态模型(Stateful)

Actor模型：每个业务对象一个goroutine
消息串行化：同一Actor内消息按顺序处理
状态管理：支持Actor迁移、持久化
适用场景：游戏服务器、会话管理
异步模型(Async)

单线程模型：避免并发问题
非阻塞处理：适合高频低延迟场景
回调机制：业务自定义异步逻辑
五、关键设计亮点
1.协程管理

熔断保护：防止goroutine泄漏
监控上报：实时统计协程使用情况
动态调整：支持运行时修改并发限制

2. 消息处理流程
   传输层接收 → 2. 解码消息 → 3. 分发层路由 → 4. 消息层处理 → 5. 业务逻辑 → 6. 响应返回

3. 扩展性设计

过滤器链：支持AOP编程模式
插件机制：可插拔的传输协议
配置热更新：无需重启修改配置

4. 监控与观测

指标收集：消息处理耗时、错误率、并发数
链路追踪：基于trace ID的分布式追踪
日志记录：完整的请求生命周期日志